<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Kidney Exchange - Hybrid Data</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }
        body { background: #09090b; color: #e4e4e7; font-family: 'Inter', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 420px; background: #18181b; border-right: 1px solid #27272a; padding: 20px; display: flex; flex-direction: column; gap: 15px; z-index: 2; overflow-y: auto; }
        .main { flex: 1; position: relative; background: radial-gradient(circle at 50% 50%, #1c1c1c 0%, #000 100%); }
        h1 { font-family: 'JetBrains Mono'; font-size: 18px; color: #3b82f6; margin: 0; }
        h2 { font-size: 13px; color: #a1a1aa; margin: 0 0 12px 0; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
        h3 { font-size: 12px; color: #71717a; margin: 10px 0 6px 0; text-transform: uppercase; font-weight: 600; }
        
        .card { background: #000; border: 1px solid #27272a; border-radius: 8px; padding: 12px; margin-bottom: 10px; }
        .card-urgent { border-left: 3px solid #ef4444; }
        .card-success { border-left: 3px solid #22c55e; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 13px; }
        .stat-label { color: #71717a; }
        .stat-val { font-family: 'JetBrains Mono'; color: #fff; font-weight: bold; }
        .stat-val.urgent { color: #ef4444; }
        .stat-val.success { color: #22c55e; }
        
        .btn-group { display: flex; gap: 5px; background: #000; padding: 8px; border-radius: 6px; border: 1px solid #27272a; margin-bottom: 10px; }
        .btn { flex: 1; background: none; border: none; color: #71717a; padding: 10px; cursor: pointer; font-weight: 600; border-radius: 4px; transition: 0.2s; font-size: 12px; }
        .btn:hover { color: #fff; background: rgba(255,255,255,0.05); }
        .btn.active { background: #3b82f6; color: #fff; }
        
        .story-text { font-size: 12px; line-height: 1.6; color: #a1a1aa; display: none; }
        .story-text.active { display: block; animation: fadeIn 0.3s; }
        
        .algorithm-box { background: rgba(59, 130, 246, 0.08); border: 1px solid #3b82f6; border-radius: 6px; padding: 10px; margin: 8px 0; font-size: 11px; line-height: 1.5; }
        .algorithm-box code { background: #000; padding: 2px 4px; border-radius: 3px; font-family: 'JetBrains Mono'; color: #eab308; }
        
        .formula { background: #000; border: 1px solid #333; padding: 8px; border-radius: 4px; font-family: 'JetBrains Mono'; font-size: 11px; margin: 5px 0; color: #a1a1aa; line-height: 1.4; }
        
        .info-btn { background: rgba(234, 179, 8, 0.1); border: 1px solid #eab308; color: #eab308; padding: 8px; width: 100%; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: bold; text-transform: uppercase; transition: 0.2s; }
        .info-btn:hover { background: rgba(234, 179, 8, 0.2); }
        
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); backdrop-filter: blur(5px); overflow-y: auto; }
        .modal-content { background-color: #18181b; margin: 30px auto; padding: 25px; border: 1px solid #3b82f6; width: 60%; max-width: 800px; border-radius: 10px; box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); position: relative; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 20px; }
        .close:hover { color: white; }
        
        .legend { position: absolute; bottom: 20px; left: 20px; background: rgba(0,0,0,0.8); padding: 12px; border-radius: 6px; border: 1px solid #333; font-size: 11px; z-index: 10; }
        .dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
        
        .chart-container { background: #000; border: 1px solid #27272a; border-radius: 6px; padding: 12px; margin: 10px 0; }
        .chart-container canvas { max-height: 200px; }
        
        .warning-box { background: rgba(239, 68, 68, 0.1); border-left: 3px solid #ef4444; padding: 10px; border-radius: 4px; font-size: 11px; }
        
        .quick-btn { flex: 1; background: #18181b; border: 1px solid #27272a; color: #a1a1aa; padding: 6px; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: bold; transition: 0.2s; }
        .quick-btn:hover { background: #27272a; color: #fff; border-color: #3b82f6; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="sidebar">
    <div>
        <h1>üè• KIDNEY MATCH v6.0</h1>
        <div style="font-size: 10px; color: #555; margin-top: 4px;">ML + TH√âORIE DES JEUX</div>
    </div>

    <!-- CONTR√îLE NOMBRE DE PATIENTS -->
    <div class="card" style="margin-top: 10px;">
        <h3 style="margin-top: 0;">üéõÔ∏è Nombre de Patients</h3>
        <div style="display: flex; gap: 8px; align-items: center;">
            <input type="number" id="patientCount" value="30" min="5" max="200" 
                   style="flex: 1; background: #18181b; border: 1px solid #3b82f6; color: #fff; padding: 8px; border-radius: 4px; font-family: 'JetBrains Mono'; font-size: 14px; font-weight: bold;">
            <button onclick="regenerate()" 
                    style="background: #3b82f6; border: none; color: #fff; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px;">
                G√âN√âRER
            </button>
        </div>
        <div id="commandOutput" style="display: none; margin-top: 8px; background: #000; border: 1px solid #eab308; padding: 8px; border-radius: 4px; font-size: 10px; font-family: 'JetBrains Mono'; color: #eab308; line-height: 1.4;">
            <div style="margin-bottom: 4px; color: #a1a1aa;">üìã Copie cette commande dans ton terminal :</div>
            <div id="commandText" style="user-select: all; color: #fff;"></div>
        </div>
        <div style="display: flex; gap: 4px; margin-top: 6px;">
            <button onclick="quickGen(10)" class="quick-btn">10</button>
            <button onclick="quickGen(20)" class="quick-btn">20</button>
            <button onclick="quickGen(50)" class="quick-btn">50</button>
            <button onclick="quickGen(100)" class="quick-btn">100</button>
        </div>
    </div>

    <div class="btn-group">
        <button class="btn active" onclick="setStep(1)">1. DONN√âES</button>
        <button class="btn" onclick="setStep(2)">2. URGENCE</button>
        <button class="btn" onclick="setStep(3)">3. MATCHING</button>
        <button class="btn" onclick="setStep(4)">4. D√âTAILS</button>
    </div>
    
    <button class="info-btn" onclick="openModal('methods')">üìä M√©thodologie Compl√®te</button>
    <button class="info-btn" onclick="openModal('urgent')">‚ö†Ô∏è Comment Calculer l'Urgence ?</button>
    <button class="info-btn" onclick="openModal('matching')">üîó Algorithme de Matching</button>

    <!-- STEP 1: DONN√âES -->
    <div id="story-1" class="story-text active">
        <h2>üì• Donn√©es Cliniques R√©elles</h2>
        <div class="card">
            <div class="stat-row">
                <span class="stat-label">PATIENTS CHARG√âS</span>
                <span class="stat-val">30</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">SOURCE</span>
                <span class="stat-val" style="font-size:10px;">Synth√©tique</span>
            </div>
        </div>
        
        <h3>üîÑ Principe des √âchanges Crois√©s</h3>
        <div class="card" style="font-size:11px; line-height:1.7; background: rgba(59, 130, 246, 0.05);">
            <b>Chaque personne = PATIENT + DONNEUR :</b><br><br>
            
            <b>Patient #1</b><br>
            ‚Ä¢ A besoin d'un rein (groupe A)<br>
            ‚Ä¢ A un donneur volontaire (fr√®re, groupe O)<br>
            ‚Ä¢ ‚ùå Incompatibles entre eux !<br><br>
            
            <b>Patient #2</b><br>
            ‚Ä¢ A besoin d'un rein (groupe O)<br>
            ‚Ä¢ A un donneur volontaire (s≈ìur, groupe A)<br>
            ‚Ä¢ ‚ùå Incompatibles entre eux !<br><br>
            
            <b style="color: #22c55e;">‚úÖ √âCHANGE CROIS√â :</b><br>
            ‚Ä¢ Donneur #1 (O) ‚Üí Patient #2 (O)<br>
            ‚Ä¢ Donneur #2 (A) ‚Üí Patient #1 (A)<br>
            <b>Les deux sont sauv√©s !</b>
        </div>
        
        <h3>Param√®tres Physiologiques</h3>
        <div class="card" style="font-size:11px; line-height:1.6;">
            <b>‚úì Cr√©atinine (SC)</b> - Fonction r√©nale<br>
            <b>‚úì H√©moglobine</b> - Sant√© g√©n√©rale<br>
            <b>‚úì √Çge</b> - Crit√®re temporel<br>
            <b>‚úì Diab√®te (DM)</b> - Comorbidit√©<br>
            <b>‚úì Tension</b> - Stabilit√© cardiovasculaire
        </div>
        
        <h3>Groupes Sanguins (Simul√©s)</h3>
        <div class="card" style="font-size:11px;">
            Distribution mondiale:
            <div style="margin-top:5px; font-family: JetBrains Mono;">
            O: 45% | A: 40% | B: 11% | AB: 4%
            </div>
        </div>
    </div>

    <!-- STEP 2: URGENCE (SCORING) -->
    <div id="story-2" class="story-text">
        <h2>‚ö° Scoring d'Urgence (I.A.)</h2>
        
        <h3>üéØ Patient Critique</h3>
        <div class="card card-urgent">
            <div class="stat-row">
                <span class="stat-label">ID</span>
                <span class="stat-val urgent">#0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">SCORE</span>
                <span class="stat-val urgent">100/100</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Cr√©atinine</span>
                <span class="stat-val">3.53</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">√Çge</span>
                <span class="stat-val">61 ans</span>
            </div>
        </div>
        
        <h3>‚öôÔ∏è Formule du Score</h3>
        <div class="algorithm-box">
            <code>SCORE = (Cr√©at√ó0.6) + (¬¨Hemo√ó0.2) + (Age√ó0.2) + (Diab√®te√ó0.1)</code>
            <br><br>
            ‚Ä¢ <b>Cr√©atinine (60%)</b> = Principal indicateur d√©faillance<br>
            ‚Ä¢ <b>H√©moglobine invers√©e (20%)</b> = Sant√© g√©n√©rale<br>
            ‚Ä¢ <b>√Çge normalis√© (20%)</b> = Temps critique<br>
            ‚Ä¢ <b>Diab√®te (10%)</b> = Facteur aggravant
        </div>
        
        <div class="chart-container">
            <canvas id="scoreChart"></canvas>
        </div>
        
        <h3>Interpr√©tation</h3>
        <div class="card">
            <div style="font-size:11px; line-height:1.6;">
            üî¥ <b>80-100</b>: CRITIQUE (transfusion imm√©diate)<br>
            üü° <b>50-79</b>: GRAVE (d√©lai semaines)<br>
            üü¢ <b>&lt;50</b>: STABLE (attente acceptable)
            </div>
        </div>
    </div>

    <!-- STEP 3: MATCHING -->
    <div id="story-3" class="story-text">
        <h2>üîó Matching par Th√©orie des Jeux</h2>
        
        <h3>Cycles Trouv√©s</h3>
        <div class="card card-success">
            <div class="stat-row">
                <span class="stat-label">CYCLES VALIDES</span>
                <span class="stat-val success">4</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">PATIENTS SAUV√âS</span>
                <span class="stat-val success">11</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">TAUX SUCC√àS</span>
                <span class="stat-val success">36%</span>
            </div>
        </div>
        
        <h3>Algorithme Gale-Shapley</h3>
        <div class="algorithm-box">
            <b>√âtape 1:</b> Graphe ABO (compatibilit√© d√©terministe)<br>
            <b>√âtape 2:</b> D√©tection cycles 2-3 n≈ìuds<br>
            <b>√âtape 3:</b> Score = Œ£ urgence(cycle)<br>
            <b>√âtape 4:</b> Tri par utilit√© d√©croissante<br>
            <b>√âtape 5:</b> S√©lection greedy (sans intersection)
        </div>
        
        <h3>Garanties Th√©oriques</h3>
        <div class="card" style="font-size:11px;">
            ‚úì <b>Stable Matching:</b> Aucune d√©viation profitable<br>
            ‚úì <b>Pareto Optimal:</b> Max surplus social<br>
            ‚úì <b>Nash Equilibrium:</b> √âquilibre atteint<br>
            ‚úì <b>Core Solution:</b> Dans le c≈ìur du jeu
        </div>
    </div>

    <!-- STEP 4: D√âTAILS -->
    <div id="story-4" class="story-text">
        <h2>üìà Analyse D√©taill√©e</h2>
        
        <h3>Distribution Scores</h3>
        <div class="chart-container">
            <canvas id="histChart"></canvas>
        </div>
        
        <h3>Compatibilit√© ABO</h3>
        <div class="card" style="font-size:10px; line-height:1.5;">
            <b>O ‚Üí</b> O, A, B, AB (universel) <br>
            <b>A ‚Üí</b> A, AB<br>
            <b>B ‚Üí</b> B, AB<br>
            <b>AB ‚Üí</b> AB (receveur universel)
        </div>
        
        <h3>Statut Patients</h3>
        <div class="card card-success">
            <div class="stat-row">
                <span>Sauv√©s par √©changes</span>
                <span class="stat-val success">11</span>
            </div>
            <div class="stat-row">
                <span>En attente (incompat.)</span>
                <span class="stat-val">19</span>
            </div>
        </div>
    </div>
</div>

<div class="main">
    <div id="network" style="width: 100%; height: 100%;"></div>
    <div class="legend" id="legend"></div>
</div>

<!-- MODAL: M√âTHODOLOGIE -->
<div id="methodsModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('methods')">&times;</span>
    <h2 style="color: #3b82f6; margin-top:0;">üìä M√©thodologie Compl√®te</h2>
    
    <h3>1. COLLECTE DE DONN√âES</h3>
    <p style="font-size:12px; line-height:1.7; color:#e4e4e7;">
        Les donn√©es physiologiques (<b>cr√©atinine, h√©moglobine, √¢ge, tension</b>) sont <b>g√©n√©r√©es synth√©tiquement</b> selon des distributions r√©alistes.
        <br><br>
        Les <b>donn√©es immunologiques</b> (groupes sanguins ABO/Rh, typage HLA 3 loci, PRA) sont √©galement <b>g√©n√©r√©es al√©atoirement</b> selon les fr√©quences r√©elles mondiales.
    </p>
    
    <h3>2. PR√âTRAITEMENT</h3>
    <p style="font-size:12px; line-height:1.7; color:#e4e4e7;">
        ‚Ä¢ Imputation des valeurs manquantes (m√©diane)<br>
        ‚Ä¢ Gestion des valeurs infinies<br>
        ‚Ä¢ Normalisation MinMax [0, 1]<br>
        ‚Ä¢ Limitation √† 30 patients pour visualisation
    </p>
    
    <h3>3. SCORING D'URGENCE (Intelligence Artificielle)</h3>
    <div class="formula">
SCORE = 0.6 √ó (Cr√©at - min) / (max - min)
       + 0.2 √ó (1 - (Hemo - min) / (max - min))
       + 0.2 √ó (Age / 100)
       + 0.1 √ó [Diab√®te pr√©sent ?]
    </div>
    <p style="font-size:12px; color:#a1a1aa;">
        <b>Interpr√©tation:</b> Plus le score est √©lev√©, plus le patient est urgent.
    </p>
    
    <h3>4. GRAPHE DE COMPATIBILIT√â ABO</h3>
    <p style="font-size:12px; line-height:1.7; color:#e4e4e7;">
        Un <b>graphe orient√©</b> est construit o√π:<br>
        ‚Ä¢ N≈ìud i ‚Üí j existe si Donneur(i) peut aider Patient(j)<br>
        ‚Ä¢ Compatibilit√© d√©termin√©e par <b>r√®gles ABO</b><br>
        ‚Ä¢ Facteur immunologique: 80% de probabilit√© de match
    </p>
    
    <h3>5. D√âTECTION DE CYCLES (Th√©orie des Graphes)</h3>
    <p style="font-size:12px; line-height:1.7; color:#e4e4e7;">
        Algorithme <code>NetworkX.simple_cycles()</code> pour d√©tecter cycles ferm√©s:<br>
        ‚Ä¢ Cycles 2-cycles: √âchange direct (A‚ÜîB)<br>
        ‚Ä¢ Cycles 3-cycles: √âchange triangulaire (A‚ÜíB‚ÜíC‚ÜíA)
    </p>
    
    <h3>6. OPTIMISATION (Stable Matching)</h3>
    <div class="algorithm-box" style="border-color:#22c55e; background:rgba(34,197,94,0.08);">
        <b>Algorithme Gale-Shapley:</b><br>
        1. Calculer utilit√© chaque cycle: Œ£ urgences<br>
        2. Trier cycles par utilit√© (d√©croissant)<br>
        3. S√©lection greedy: Max cycles disjoints<br>
        4. R√©sultat: Stable matching + Pareto optimal
    </div>
    
    <h3>7. R√âSULTAT FINAL</h3>
    <p style="font-size:12px; color:#a1a1aa;">
        <b>11 patients sauv√©s</b> parmi 30 via <b>4 cycles d'√©change</b>.<br>
        Taux de succ√®s: <b>36%</b>
    </p>
  </div>
</div>

<!-- MODAL: URGENCE -->
<div id="urgentModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('urgent')">&times;</span>
    <h2 style="color: #ef4444; margin-top:0;">‚ö†Ô∏è Calcul de l'Urgence</h2>
    
    <h3>Pourquoi l'urgence ?</h3>
    <p style="font-size:12px; line-height:1.7; color:#e4e4e7;">
        Dans un r√©seau d'√©changes r√©naux, il est <b>√©thiquement crucial</b> de donner la priorit√© 
        aux patients les plus graves. Le score d'urgence combine plusieurs facteurs cliniques 
        pour identifier rapidement qui a besoin d'une transplantation imm√©diate.
    </p>
    
    <h3>Composantes du Score</h3>
    
    <div class="card">
        <b>üî¥ CR√âATININE (60% du poids)</b><br>
        <p style="font-size:11px; line-height:1.5; color:#a1a1aa; margin:8px 0;">
            Mesure principale de la fonction r√©nale. Plus elle est √©lev√©e, plus les reins d√©faillent.
            Normalis√©e entre 0 et 1.
        </p>
    </div>
    
    <div class="card">
        <b>üü° H√âMOGLOBINE (20% - inverse)</b><br>
        <p style="font-size:11px; line-height:1.5; color:#a1a1aa; margin:8px 0;">
            Une faible h√©moglobine indique une an√©mie s√©v√®re (complication r√©nale fr√©quente).
            On l'inverse: basse h√©moglobine = score haut.
        </p>
    </div>
    
    <div class="card">
        <b>üü¢ √ÇGE (20%)</b><br>
        <p style="font-size:11px; line-height:1.5; color:#a1a1aa; margin:8px 0;">
            Les patients plus √¢g√©s ont une fen√™tre temporelle plus r√©duite. Normalis√© sur 100 ans.
        </p>
    </div>
    
    <div class="card">
        <b>üü† DIAB√àTE (10% suppl√©mentaire)</b><br>
        <p style="font-size:11px; line-height:1.5; color:#a1a1aa; margin:8px 0;">
            Le diab√®te complique la maladie r√©nale et r√©duit les options de transplantation.
        </p>
    </div>
    
    <h3>Exemple Concret</h3>
    <div class="algorithm-box" style="background:rgba(59,130,246,0.08); border-color:#3b82f6;">
        <b>Patient #0:</b><br>
        Cr√©at=3.53 | Age=61 | Score=<span style="color:#ef4444">100</span>/100<br><br>
        ‚Üí <span style="color:#ef4444;font-weight:bold;">CRITIQUE - PRIORIT√â IMM√âDIATE</span>
    </div>
  </div>
</div>

<!-- MODAL: MATCHING -->
<div id="matchingModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('matching')">&times;</span>
    <h2 style="color: #00d2ff; margin-top:0;">üîó Algorithme de Matching (Stable Matching)</h2>
    
    <h3>Contexte: Jeu de Coalition</h3>
    <p style="font-size:12px; line-height:1.7; color:#e4e4e7;">
        L'√©change r√©nal est un <b>jeu de coalition</b> o√π:
        <br>‚Ä¢ Chaque patient veut un rein compatible<br>
        ‚Ä¢ Chaque donneur veut aider un patient urgent<br>
        ‚Ä¢ Les ressources sont limit√©es (compatibilit√© ABO)
    </p>
    
    <h3>Th√©orie des Jeux: Stable Matching</h3>
    <p style="font-size:12px; line-height:1.7; color:#e4e4e7;">
        Un matching est <b>stable</b> si:<br>
        ‚úì Aucun couple Donneur-Patient ne peut se d√©vier<br>
        ‚úì Aucun cycle ne peut abandonner pour un meilleur cycle<br>
        ‚úì L'allocation est <b>Pareto optimale</b> (max surplus)
    </p>
    
    <h3>Algorithme Gale-Shapley (Adapt√©)</h3>
    <div class="algorithm-box" style="background:rgba(0,210,255,0.08); border-color:#00d2ff;">
        <b>√âTAPE 1: Construire Graphe ABO</b><br>
        Pour chaque donneur i et patient j:<br>
        ‚Ä¢ Si groupe(j) ‚àà compatibles(groupe(i))<br>
        ‚Ä¢ Ajouter ar√™te i ‚Üí j<br>
        ‚Ä¢ Poids = urgence(j)<br><br>
        
        <b>√âTAPE 2: D√©tecter Tous les Cycles</b><br>
        Algorithme rapide: <code>nx.simple_cycles()</code><br>
        Limite: longueur ‚â§ 3 (viabilit√© m√©dicale)<br><br>
        
        <b>√âTAPE 3: √âvaluer Utilit√© Sociale</b><br>
        Pour chaque cycle C:<br>
        <code>utilit√©(C) = Œ£ urgence(n) + bonus[max urgence &gt; 80]</code><br><br>
        
        <b>√âTAPE 4: S√©lection Greedy</b><br>
        Trier cycles par utilit√© (d√©croissant)<br>
        S√©lectionner cycles disjoints (max urgence)<br>
        R√©sultat = Stable matching<br><br>
        
        <b>√âTAPE 5: Validation Nash</b><br>
        V√©rifier: Aucune coalition ne peut d√©vier
    </div>
    
    <h3>R√©sultat: Core Solution</h3>
    <p style="font-size:12px; line-height:1.7; color:#a1a1aa;">
        <b>4 cycles</b> d'√©change d√©tect√©s<br>
        <b>11 patients</b> sauv√©s par ces cycles<br>
        <b>Efficacit√© Pareto:</b> 36%
    </p>
  </div>
</div>

<script>
    const nodesRaw = [{"id": 0, "label": "P0", "title": "<b>PAIRE #0</b><br><br><b>PATIENT:</b><br>Groupe: A<br>Cr\u00e9atinine: 3.5<br>Age: 61<br>Score Urgence: 99/100<br><br><b>DONNEUR:</b><br>Donneur: O", "val": 99, "ai_color": "#ef4444", "gt_color": "#a333ff", "cid": 3, "group": "saved", "in_any_cycle": true, "blood": "A", "compatible": "O,A", "donor": 1}, {"id": 1, "label": "P1", "title": "<b>PAIRE #1</b><br><br><b>PATIENT:</b><br>Groupe: A<br>Cr\u00e9atinine: 2.7<br>Age: 74<br>Score Urgence: 12/100<br><br><b>DONNEUR:</b><br>Donneur: O", "val": 12, "ai_color": "#22c55e", "gt_color": "#a333ff", "cid": 3, "group": "saved", "in_any_cycle": true, "blood": "A", "compatible": "O,A", "donor": 18}, {"id": 2, "label": "P2", "title": "<b>PAIRE #2</b><br><br><b>PATIENT:</b><br>Groupe: A<br>Cr\u00e9atinine: 4.2<br>Age: 79<br>Score Urgence: 95/100<br><br><b>DONNEUR:</b><br>Pas de donneur", "val": 95, "ai_color": "#ef4444", "gt_color": "#333", "cid": -1, "group": "lost", "in_any_cycle": false, "blood": "A", "compatible": "O,A", "donor": -1}, {"id": 3, "label": "P3", "title": "<b>PAIRE #3</b><br><br><b>PATIENT:</b><br>Groupe: O<br>Cr\u00e9atinine: 0.6<br>Age: 43<br>Score Urgence: 70/100<br><br><b>DONNEUR:</b><br>Donneur: O", "val": 70, "ai_color": "#eab308", "gt_color": "#333", "cid": -1, "group": "lost", "in_any_cycle": true, "blood": "O", "compatible": "O", "donor": -1}, {"id": 4, "label": "P4", "title": "<b>PAIRE #4</b><br><br><b>PATIENT:</b><br>Groupe: A<br>Cr\u00e9atinine: 4.1<br>Age: 62<br>Score Urgence: 85/100<br><br><b>DONNEUR:</b><br>Donneur: A", "val": 85, "ai_color": "#ef4444", "gt_color": "#bcff03", "cid": 2, "group": "saved", "in_any_cycle": true, "blood": "A", "compatible": "O,A", "donor": 13}, {"id": 5, "label": "P5", "title": "<b>PAIRE #5</b><br><br><b>PATIENT:</b><br>Groupe: A<br>Cr\u00e9atinine: 3.0<br>Age: 57<br>Score Urgence: 70/100<br><br><b>DONNEUR:</b><br>Pas de donneur", "val": 70, "ai_color": "#eab308", "gt_color": "#333", "cid": -1, "group": "lost", "in_any_cycle": false, "blood": "A", "compatible": "O,A", "donor": -1}, {"id": 6, "label": "P6", "title": "<b>PAIRE #6</b><br><br><b>PATIENT:</b><br>Groupe: O<br>Cr\u00e9atinine: 1.8<br>Age: 52<br>Score Urgence: 73/100<br><br><b>DONNEUR:</b><br>Donneur: O", "val": 73, "ai_color": "#eab308", "gt_color": "#333", "cid": -1, "group": "lost", "in_any_cycle": false, "blood": "O", "compatible": "O", "donor": -1}, {"id": 7, "label": "P7", "title": "<b>PAIRE #7</b><br><br><b>PATIENT:</b><br>Groupe: O<br>Cr\u00e9atinine: 0.7<br>Age: 23<br>Score Urgence: 24/100<br><br><b>DONNEUR:</b><br>Donneur: O", "val": 24, "ai_color": "#22c55e", "gt_color": "#ff005c", "cid": 1, "group": "saved", "in_any_cycle": true, "blood": "O", "compatible": "O", "donor": 22}, {"id": 8, "label": "P8", "title": "<b>PAIRE #8</b><br><br><b>PATIENT:</b><br>Groupe: AB<br>Cr\u00e9atinine: 5.0<br>Age: 27<br>Score Urgence: 81/100<br><br><b>DONNEUR:</b><br>Donneur: AB", "val": 81, "ai_color": "#ef4444", "gt_color": "#333", "cid": -1, "group": "lost", "in_any_cycle": false, "blood": "AB", "compatible": "O,A,B,AB", "donor": -1}, {"id": 9, "label": "P9", "title": "<b>PAIRE #9</b><br><br><b>PATIENT:</b><br>Groupe: O<br>Cr\u00e9atinine: 0.5<br>Age: 48<br>Score Urgence: 2/100<br><br><b>DONNEUR:</b><br>Pas de donneur", "val": 2, "ai_color": "#22c55e", "gt_color": "#333", "cid": -1, "group": "lost", "in_any_cycle": false, "blood": "O", "compatible": "O", "donor": -1}, {"id": 10, "label": "P10", "title": "<b>PAIRE #10</b><br><br><b>PATIENT:</b><br>Groupe: A<br>Cr\u00e9atinine: 4.0<br>Age: 65<br>Score Urgence: 90/100<br><br><b>DONNEUR:</b><br>Donneur: O", "val": 90, "ai_color": "#ef4444", "gt_color": "#333", "cid": -1, "group": "lost", "in_any_cycle": false, "blood": "A", "compatible": "O,A", "donor": -1}, {"id": 11, "label": "P11", "title": "<b>PAIRE #11</b><br><br><b>PATIENT:</b><br>Groupe: A<br>Cr\u00e9atinine: 3.9<br>Age: 79<br>Score Urgence: 95/100<br><br><b>DONNEUR:</b><br>Donneur: O", "val": 95, "ai_color": "#ef4444", "gt_color": "#00d2ff", "cid": 0, "group": "saved", "in_any_cycle": true, "blood": "A", "compatible": "O,A", "donor": 23}, {"id": 12, "label": "P12", "title": "<b>PAIRE #12</b><br><br><b>PATIENT:</b><br>Groupe: O<br>Cr\u00e9atinine: 2.2<br>Age: 89<br>Score Urgence: 98/100<br><br><b>DONNEUR:</b><br>Pas de donneur", "val": 98, "ai_color": "#ef4444", "gt_color": "#333", "cid": -1, "group": "lost", "in_any_cycle": false, "blood": "O", "compatible": "O", "donor": -1}, {"id": 13, "label": "P13", "title": "<b>PAIRE #13</b><br><br><b>PATIENT:</b><br>Groupe: A<br>Cr\u00e9atinine: 2.7<br>Age: 65<br>Score Urgence: 99/100<br><br><b>DONNEUR:</b><br>Donneur: A", "val": 99, "ai_color": "#ef4444", "gt_color": "#bcff03", "cid": 2, "group": "saved", "in_any_cycle": true, "blood": "A", "compatible": "O,A", "donor": 4}, {"id": 14, "label": "P14", "title": "<b>PAIRE #14</b><br><br><b>PATIENT:</b><br>Groupe: B<br>Cr\u00e9atinine: 4.7<br>Age: 59<br>Score Urgence: 96/100<br><br><b>DONNEUR:</b><br>Donneur: A", "val": 96, "ai_color": "#ef4444", "gt_color": "#333", "cid": -1, "group": "lost", "in_any_cycle": false, "blood": "B", "compatible": "O,B", "donor": -1}, {"id": 15, "label": "P15", "title": "<b>PAIRE #15</b><br><br><b>PATIENT:</b><br>Groupe: O<br>Cr\u00e9atinine: 2.3<br>Age: 75<br>Score Urgence: 39/100<br><br><b>DONNEUR:</b><br>Donneur: B", "val": 39, "ai_color": "#22c55e", "gt_color": "#333", "cid": -1, "group": "lost", "in_any_cycle": false, "blood": "O", "compatible": "O", "donor": -1}, {"id": 16, "label": "P16", "title": "<b>PAIRE #16</b><br><br><b>PATIENT:</b><br>Groupe: AB<br>Cr\u00e9atinine: 4.9<br>Age: 76<br>Score Urgence: 82/100<br><br><b>DONNEUR:</b><br>Donneur: O", "val": 82, "ai_color": "#ef4444", "gt_color": "#00d2ff", "cid": 0, "group": "saved", "in_any_cycle": true, "blood": "AB", "compatible": "O,A,B,AB", "donor": 11}, {"id": 17, "label": "P17", "title": "<b>PAIRE #17</b><br><br><b>PATIENT:</b><br>Groupe: A<br>Cr\u00e9atinine: 2.9<br>Age: 68<br>Score Urgence: 99/100<br><br><b>DONNEUR:</b><br>Donneur: A", "val": 99, "ai_color": "#ef4444", "gt_color": "#333", "cid": -1, "group": "lost", "in_any_cycle": false, "blood": "A", "compatible": "O,A", "donor": -1}, {"id": 18, "label": "P18", "title": "<b>PAIRE #18</b><br><br><b>PATIENT:</b><br>Groupe: O<br>Cr\u00e9atinine: 0.9<br>Age: 54<br>Score Urgence: 2/100<br><br><b>DONNEUR:</b><br>Donneur: A", "val": 2, "ai_color": "#22c55e", "gt_color": "#a333ff", "cid": 3, "group": "saved", "in_any_cycle": true, "blood": "O", "compatible": "O", "donor": 0}, {"id": 19, "label": "P19", "title": "<b>PAIRE #19</b><br><br><b>PATIENT:</b><br>Groupe: A<br>Cr\u00e9atinine: 4.2<br>Age: 72<br>Score Urgence: 96/100<br><br><b>DONNEUR:</b><br>Donneur: O", "val": 96, "ai_color": "#ef4444", "gt_color": "#ff005c", "cid": 1, "group": "saved", "in_any_cycle": true, "blood": "A", "compatible": "O,A", "donor": 7}, {"id": 20, "label": "P20", "title": "<b>PAIRE #20</b><br><br><b>PATIENT:</b><br>Groupe: O<br>Cr\u00e9atinine: 1.5<br>Age: 52<br>Score Urgence: 87/100<br><br><b>DONNEUR:</b><br>Pas de donneur", "val": 87, "ai_color": "#ef4444", "gt_color": "#333", "cid": -1, "group": "lost", "in_any_cycle": false, "blood": "O", "compatible": "O", "donor": -1}, {"id": 21, "label": "P21", "title": "<b>PAIRE #21</b><br><br><b>PATIENT:</b><br>Groupe: A<br>Cr\u00e9atinine: 3.0<br>Age: 47<br>Score Urgence: 96/100<br><br><b>DONNEUR:</b><br>Pas de donneur", "val": 96, "ai_color": "#ef4444", "gt_color": "#333", "cid": -1, "group": "lost", "in_any_cycle": false, "blood": "A", "compatible": "O,A", "donor": -1}, {"id": 22, "label": "P22", "title": "<b>PAIRE #22</b><br><br><b>PATIENT:</b><br>Groupe: O<br>Cr\u00e9atinine: 1.8<br>Age: 84<br>Score Urgence: 86/100<br><br><b>DONNEUR:</b><br>Donneur: O", "val": 86, "ai_color": "#ef4444", "gt_color": "#ff005c", "cid": 1, "group": "saved", "in_any_cycle": true, "blood": "O", "compatible": "O", "donor": 19}, {"id": 23, "label": "P23", "title": "<b>PAIRE #23</b><br><br><b>PATIENT:</b><br>Groupe: A<br>Cr\u00e9atinine: 4.2<br>Age: 78<br>Score Urgence: 95/100<br><br><b>DONNEUR:</b><br>Donneur: O", "val": 95, "ai_color": "#ef4444", "gt_color": "#00d2ff", "cid": 0, "group": "saved", "in_any_cycle": true, "blood": "A", "compatible": "O,A", "donor": 16}, {"id": 24, "label": "P24", "title": "<b>PAIRE #24</b><br><br><b>PATIENT:</b><br>Groupe: A<br>Cr\u00e9atinine: 4.2<br>Age: 52<br>Score Urgence: 91/100<br><br><b>DONNEUR:</b><br>Pas de donneur", "val": 91, "ai_color": "#ef4444", "gt_color": "#333", "cid": -1, "group": "lost", "in_any_cycle": false, "blood": "A", "compatible": "O,A", "donor": -1}, {"id": 25, "label": "P25", "title": "<b>PAIRE #25</b><br><br><b>PATIENT:</b><br>Groupe: O<br>Cr\u00e9atinine: 1.5<br>Age: 37<br>Score Urgence: 2/100<br><br><b>DONNEUR:</b><br>Pas de donneur", "val": 2, "ai_color": "#22c55e", "gt_color": "#333", "cid": -1, "group": "lost", "in_any_cycle": false, "blood": "O", "compatible": "O", "donor": -1}, {"id": 26, "label": "P26", "title": "<b>PAIRE #26</b><br><br><b>PATIENT:</b><br>Groupe: A<br>Cr\u00e9atinine: 3.4<br>Age: 33<br>Score Urgence: 12/100<br><br><b>DONNEUR:</b><br>Pas de donneur", "val": 12, "ai_color": "#22c55e", "gt_color": "#333", "cid": -1, "group": "lost", "in_any_cycle": false, "blood": "A", "compatible": "O,A", "donor": -1}, {"id": 27, "label": "P27", "title": "<b>PAIRE #27</b><br><br><b>PATIENT:</b><br>Groupe: O<br>Cr\u00e9atinine: 0.9<br>Age: 75<br>Score Urgence: 0/100<br><br><b>DONNEUR:</b><br>Donneur: O", "val": 0, "ai_color": "#22c55e", "gt_color": "#333", "cid": -1, "group": "lost", "in_any_cycle": true, "blood": "O", "compatible": "O", "donor": -1}, {"id": 28, "label": "P28", "title": "<b>PAIRE #28</b><br><br><b>PATIENT:</b><br>Groupe: O<br>Cr\u00e9atinine: 2.4<br>Age: 45<br>Score Urgence: 91/100<br><br><b>DONNEUR:</b><br>Donneur: B", "val": 91, "ai_color": "#ef4444", "gt_color": "#333", "cid": -1, "group": "lost", "in_any_cycle": false, "blood": "O", "compatible": "O", "donor": -1}, {"id": 29, "label": "P29", "title": "<b>PAIRE #29</b><br><br><b>PATIENT:</b><br>Groupe: O<br>Cr\u00e9atinine: 0.9<br>Age: 30<br>Score Urgence: 93/100<br><br><b>DONNEUR:</b><br>Pas de donneur", "val": 93, "ai_color": "#ef4444", "gt_color": "#333", "cid": -1, "group": "lost", "in_any_cycle": false, "blood": "O", "compatible": "O", "donor": -1}];
    const edgesRaw = [{"from": 0, "to": 2, "is_sol": false, "is_candidate": false}, {"from": 0, "to": 4, "is_sol": false, "is_candidate": true}, {"from": 0, "to": 11, "is_sol": false, "is_candidate": true}, {"from": 0, "to": 13, "is_sol": false, "is_candidate": false}, {"from": 0, "to": 18, "is_sol": true, "is_candidate": true}, {"from": 0, "to": 19, "is_sol": false, "is_candidate": false}, {"from": 0, "to": 26, "is_sol": false, "is_candidate": false}, {"from": 1, "to": 0, "is_sol": true, "is_candidate": true}, {"from": 1, "to": 2, "is_sol": false, "is_candidate": false}, {"from": 1, "to": 5, "is_sol": false, "is_candidate": false}, {"from": 1, "to": 11, "is_sol": false, "is_candidate": false}, {"from": 1, "to": 14, "is_sol": false, "is_candidate": false}, {"from": 1, "to": 19, "is_sol": false, "is_candidate": true}, {"from": 1, "to": 22, "is_sol": false, "is_candidate": true}, {"from": 3, "to": 0, "is_sol": false, "is_candidate": true}, {"from": 3, "to": 4, "is_sol": false, "is_candidate": false}, {"from": 3, "to": 12, "is_sol": false, "is_candidate": false}, {"from": 3, "to": 16, "is_sol": false, "is_candidate": true}, {"from": 3, "to": 21, "is_sol": false, "is_candidate": false}, {"from": 3, "to": 26, "is_sol": false, "is_candidate": false}, {"from": 4, "to": 1, "is_sol": false, "is_candidate": true}, {"from": 4, "to": 2, "is_sol": false, "is_candidate": false}, {"from": 4, "to": 5, "is_sol": false, "is_candidate": false}, {"from": 4, "to": 13, "is_sol": true, "is_candidate": true}, {"from": 6, "to": 10, "is_sol": false, "is_candidate": false}, {"from": 6, "to": 11, "is_sol": false, "is_candidate": false}, {"from": 6, "to": 12, "is_sol": false, "is_candidate": false}, {"from": 6, "to": 13, "is_sol": false, "is_candidate": false}, {"from": 6, "to": 16, "is_sol": false, "is_candidate": false}, {"from": 6, "to": 19, "is_sol": false, "is_candidate": false}, {"from": 7, "to": 2, "is_sol": false, "is_candidate": false}, {"from": 7, "to": 3, "is_sol": false, "is_candidate": true}, {"from": 7, "to": 9, "is_sol": false, "is_candidate": false}, {"from": 7, "to": 16, "is_sol": false, "is_candidate": true}, {"from": 7, "to": 19, "is_sol": true, "is_candidate": true}, {"from": 7, "to": 23, "is_sol": false, "is_candidate": false}, {"from": 7, "to": 28, "is_sol": false, "is_candidate": false}, {"from": 10, "to": 0, "is_sol": false, "is_candidate": false}, {"from": 10, "to": 1, "is_sol": false, "is_candidate": false}, {"from": 10, "to": 2, "is_sol": false, "is_candidate": false}, {"from": 10, "to": 3, "is_sol": false, "is_candidate": false}, {"from": 10, "to": 4, "is_sol": false, "is_candidate": false}, {"from": 10, "to": 5, "is_sol": false, "is_candidate": false}, {"from": 10, "to": 8, "is_sol": false, "is_candidate": false}, {"from": 10, "to": 12, "is_sol": false, "is_candidate": false}, {"from": 10, "to": 18, "is_sol": false, "is_candidate": false}, {"from": 10, "to": 22, "is_sol": false, "is_candidate": false}, {"from": 10, "to": 27, "is_sol": false, "is_candidate": false}, {"from": 11, "to": 3, "is_sol": false, "is_candidate": true}, {"from": 11, "to": 8, "is_sol": false, "is_candidate": false}, {"from": 11, "to": 12, "is_sol": false, "is_candidate": false}, {"from": 11, "to": 16, "is_sol": true, "is_candidate": true}, {"from": 11, "to": 26, "is_sol": false, "is_candidate": false}, {"from": 11, "to": 29, "is_sol": false, "is_candidate": false}, {"from": 13, "to": 4, "is_sol": true, "is_candidate": true}, {"from": 13, "to": 16, "is_sol": false, "is_candidate": false}, {"from": 14, "to": 0, "is_sol": false, "is_candidate": false}, {"from": 14, "to": 13, "is_sol": false, "is_candidate": false}, {"from": 15, "to": 8, "is_sol": false, "is_candidate": false}, {"from": 16, "to": 7, "is_sol": false, "is_candidate": true}, {"from": 16, "to": 17, "is_sol": false, "is_candidate": false}, {"from": 16, "to": 23, "is_sol": true, "is_candidate": true}, {"from": 16, "to": 26, "is_sol": false, "is_candidate": false}, {"from": 17, "to": 0, "is_sol": false, "is_candidate": false}, {"from": 17, "to": 8, "is_sol": false, "is_candidate": false}, {"from": 17, "to": 19, "is_sol": false, "is_candidate": false}, {"from": 18, "to": 1, "is_sol": true, "is_candidate": true}, {"from": 18, "to": 16, "is_sol": false, "is_candidate": false}, {"from": 18, "to": 19, "is_sol": false, "is_candidate": true}, {"from": 19, "to": 12, "is_sol": false, "is_candidate": false}, {"from": 19, "to": 18, "is_sol": false, "is_candidate": true}, {"from": 19, "to": 22, "is_sol": true, "is_candidate": true}, {"from": 19, "to": 26, "is_sol": false, "is_candidate": false}, {"from": 22, "to": 3, "is_sol": false, "is_candidate": false}, {"from": 22, "to": 4, "is_sol": false, "is_candidate": true}, {"from": 22, "to": 7, "is_sol": true, "is_candidate": true}, {"from": 22, "to": 14, "is_sol": false, "is_candidate": false}, {"from": 22, "to": 18, "is_sol": false, "is_candidate": true}, {"from": 22, "to": 21, "is_sol": false, "is_candidate": false}, {"from": 22, "to": 25, "is_sol": false, "is_candidate": false}, {"from": 22, "to": 29, "is_sol": false, "is_candidate": false}, {"from": 23, "to": 10, "is_sol": false, "is_candidate": false}, {"from": 23, "to": 11, "is_sol": true, "is_candidate": true}, {"from": 23, "to": 27, "is_sol": false, "is_candidate": true}, {"from": 27, "to": 0, "is_sol": false, "is_candidate": false}, {"from": 27, "to": 2, "is_sol": false, "is_candidate": false}, {"from": 27, "to": 4, "is_sol": false, "is_candidate": false}, {"from": 27, "to": 11, "is_sol": false, "is_candidate": false}, {"from": 27, "to": 16, "is_sol": false, "is_candidate": true}, {"from": 27, "to": 18, "is_sol": false, "is_candidate": false}, {"from": 27, "to": 19, "is_sol": false, "is_candidate": false}, {"from": 27, "to": 21, "is_sol": false, "is_candidate": false}, {"from": 28, "to": 8, "is_sol": false, "is_candidate": false}];
    
    const nodes = new vis.DataSet(nodesRaw);
    const edges = new vis.DataSet(edgesRaw);
    
    const container = document.getElementById('network');
    const data = { nodes: nodes, edges: edges };
    const options = {
        nodes: { 
            shape: 'dot', 
            font: { color: '#fff', face: 'Inter', size: 10 }, 
            borderWidth: 2,
            shadow: true 
        },
        edges: { 
            smooth: { type: 'continuous' }, 
            arrows: { to: { scaleFactor: 0.5 } },
            font: { size: 10 },
            shadow: true
        },
        physics: { 
            stabilization: { iterations: 1000 }, 
            barnesHut: { gravitationalConstant: -2000 } 
        }
    };
    
    const network = new vis.Network(container, data, options);
    
    network.once("stabilizationIterationsDone", function() {
        network.setOptions({ physics: { enabled: false } });
        network.fit();
    });

    function openModal(modalId) { 
        document.getElementById(modalId + 'Modal').style.display = "block"; 
    }
    function closeModal(modalId) { 
        document.getElementById(modalId + 'Modal').style.display = "none"; 
    }
    window.onclick = function(event) { 
        if (event.target.classList.contains('modal')) { 
            event.target.style.display = "none"; 
        } 
    }

    // Charts
    var urgencyScores = [{"id": 0, "label": "P0", "title": "<b>PAIRE #0</b><br><br><b>PATIENT:</b><br>Groupe: A<br>Cr\u00e9atinine: 3.5<br>Age: 61<br>Score Urgence: 99/100<br><br><b>DONNEUR:</b><br>Donneur: O", "val": 99, "ai_color": "#ef4444", "gt_color": "#a333ff", "cid": 3, "group": "saved", "in_any_cycle": true, "blood": "A", "compatible": "O,A", "donor": 1}, {"id": 1, "label": "P1", "title": "<b>PAIRE #1</b><br><br><b>PATIENT:</b><br>Groupe: A<br>Cr\u00e9atinine: 2.7<br>Age: 74<br>Score Urgence: 12/100<br><br><b>DONNEUR:</b><br>Donneur: O", "val": 12, "ai_color": "#22c55e", "gt_color": "#a333ff", "cid": 3, "group": "saved", "in_any_cycle": true, "blood": "A", "compatible": "O,A", "donor": 18}, {"id": 2, "label": "P2", "title": "<b>PAIRE #2</b><br><br><b>PATIENT:</b><br>Groupe: A<br>Cr\u00e9atinine: 4.2<br>Age: 79<br>Score Urgence: 95/100<br><br><b>DONNEUR:</b><br>Pas de donneur", "val": 95, "ai_color": "#ef4444", "gt_color": "#333", "cid": -1, "group": "lost", "in_any_cycle": false, "blood": "A", "compatible": "O,A", "donor": -1}, {"id": 3, "label": "P3", "title": "<b>PAIRE #3</b><br><br><b>PATIENT:</b><br>Groupe: O<br>Cr\u00e9atinine: 0.6<br>Age: 43<br>Score Urgence: 70/100<br><br><b>DONNEUR:</b><br>Donneur: O", "val": 70, "ai_color": "#eab308", "gt_color": "#333", "cid": -1, "group": "lost", "in_any_cycle": true, "blood": "O", "compatible": "O", "donor": -1}, {"id": 4, "label": "P4", "title": "<b>PAIRE #4</b><br><br><b>PATIENT:</b><br>Groupe: A<br>Cr\u00e9atinine: 4.1<br>Age: 62<br>Score Urgence: 85/100<br><br><b>DONNEUR:</b><br>Donneur: A", "val": 85, "ai_color": "#ef4444", "gt_color": "#bcff03", "cid": 2, "group": "saved", "in_any_cycle": true, "blood": "A", "compatible": "O,A", "donor": 13}, {"id": 5, "label": "P5", "title": "<b>PAIRE #5</b><br><br><b>PATIENT:</b><br>Groupe: A<br>Cr\u00e9atinine: 3.0<br>Age: 57<br>Score Urgence: 70/100<br><br><b>DONNEUR:</b><br>Pas de donneur", "val": 70, "ai_color": "#eab308", "gt_color": "#333", "cid": -1, "group": "lost", "in_any_cycle": false, "blood": "A", "compatible": "O,A", "donor": -1}, {"id": 6, "label": "P6", "title": "<b>PAIRE #6</b><br><br><b>PATIENT:</b><br>Groupe: O<br>Cr\u00e9atinine: 1.8<br>Age: 52<br>Score Urgence: 73/100<br><br><b>DONNEUR:</b><br>Donneur: O", "val": 73, "ai_color": "#eab308", "gt_color": "#333", "cid": -1, "group": "lost", "in_any_cycle": false, "blood": "O", "compatible": "O", "donor": -1}, {"id": 7, "label": "P7", "title": "<b>PAIRE #7</b><br><br><b>PATIENT:</b><br>Groupe: O<br>Cr\u00e9atinine: 0.7<br>Age: 23<br>Score Urgence: 24/100<br><br><b>DONNEUR:</b><br>Donneur: O", "val": 24, "ai_color": "#22c55e", "gt_color": "#ff005c", "cid": 1, "group": "saved", "in_any_cycle": true, "blood": "O", "compatible": "O", "donor": 22}, {"id": 8, "label": "P8", "title": "<b>PAIRE #8</b><br><br><b>PATIENT:</b><br>Groupe: AB<br>Cr\u00e9atinine: 5.0<br>Age: 27<br>Score Urgence: 81/100<br><br><b>DONNEUR:</b><br>Donneur: AB", "val": 81, "ai_color": "#ef4444", "gt_color": "#333", "cid": -1, "group": "lost", "in_any_cycle": false, "blood": "AB", "compatible": "O,A,B,AB", "donor": -1}, {"id": 9, "label": "P9", "title": "<b>PAIRE #9</b><br><br><b>PATIENT:</b><br>Groupe: O<br>Cr\u00e9atinine: 0.5<br>Age: 48<br>Score Urgence: 2/100<br><br><b>DONNEUR:</b><br>Pas de donneur", "val": 2, "ai_color": "#22c55e", "gt_color": "#333", "cid": -1, "group": "lost", "in_any_cycle": false, "blood": "O", "compatible": "O", "donor": -1}, {"id": 10, "label": "P10", "title": "<b>PAIRE #10</b><br><br><b>PATIENT:</b><br>Groupe: A<br>Cr\u00e9atinine: 4.0<br>Age: 65<br>Score Urgence: 90/100<br><br><b>DONNEUR:</b><br>Donneur: O", "val": 90, "ai_color": "#ef4444", "gt_color": "#333", "cid": -1, "group": "lost", "in_any_cycle": false, "blood": "A", "compatible": "O,A", "donor": -1}, {"id": 11, "label": "P11", "title": "<b>PAIRE #11</b><br><br><b>PATIENT:</b><br>Groupe: A<br>Cr\u00e9atinine: 3.9<br>Age: 79<br>Score Urgence: 95/100<br><br><b>DONNEUR:</b><br>Donneur: O", "val": 95, "ai_color": "#ef4444", "gt_color": "#00d2ff", "cid": 0, "group": "saved", "in_any_cycle": true, "blood": "A", "compatible": "O,A", "donor": 23}, {"id": 12, "label": "P12", "title": "<b>PAIRE #12</b><br><br><b>PATIENT:</b><br>Groupe: O<br>Cr\u00e9atinine: 2.2<br>Age: 89<br>Score Urgence: 98/100<br><br><b>DONNEUR:</b><br>Pas de donneur", "val": 98, "ai_color": "#ef4444", "gt_color": "#333", "cid": -1, "group": "lost", "in_any_cycle": false, "blood": "O", "compatible": "O", "donor": -1}, {"id": 13, "label": "P13", "title": "<b>PAIRE #13</b><br><br><b>PATIENT:</b><br>Groupe: A<br>Cr\u00e9atinine: 2.7<br>Age: 65<br>Score Urgence: 99/100<br><br><b>DONNEUR:</b><br>Donneur: A", "val": 99, "ai_color": "#ef4444", "gt_color": "#bcff03", "cid": 2, "group": "saved", "in_any_cycle": true, "blood": "A", "compatible": "O,A", "donor": 4}, {"id": 14, "label": "P14", "title": "<b>PAIRE #14</b><br><br><b>PATIENT:</b><br>Groupe: B<br>Cr\u00e9atinine: 4.7<br>Age: 59<br>Score Urgence: 96/100<br><br><b>DONNEUR:</b><br>Donneur: A", "val": 96, "ai_color": "#ef4444", "gt_color": "#333", "cid": -1, "group": "lost", "in_any_cycle": false, "blood": "B", "compatible": "O,B", "donor": -1}, {"id": 15, "label": "P15", "title": "<b>PAIRE #15</b><br><br><b>PATIENT:</b><br>Groupe: O<br>Cr\u00e9atinine: 2.3<br>Age: 75<br>Score Urgence: 39/100<br><br><b>DONNEUR:</b><br>Donneur: B", "val": 39, "ai_color": "#22c55e", "gt_color": "#333", "cid": -1, "group": "lost", "in_any_cycle": false, "blood": "O", "compatible": "O", "donor": -1}, {"id": 16, "label": "P16", "title": "<b>PAIRE #16</b><br><br><b>PATIENT:</b><br>Groupe: AB<br>Cr\u00e9atinine: 4.9<br>Age: 76<br>Score Urgence: 82/100<br><br><b>DONNEUR:</b><br>Donneur: O", "val": 82, "ai_color": "#ef4444", "gt_color": "#00d2ff", "cid": 0, "group": "saved", "in_any_cycle": true, "blood": "AB", "compatible": "O,A,B,AB", "donor": 11}, {"id": 17, "label": "P17", "title": "<b>PAIRE #17</b><br><br><b>PATIENT:</b><br>Groupe: A<br>Cr\u00e9atinine: 2.9<br>Age: 68<br>Score Urgence: 99/100<br><br><b>DONNEUR:</b><br>Donneur: A", "val": 99, "ai_color": "#ef4444", "gt_color": "#333", "cid": -1, "group": "lost", "in_any_cycle": false, "blood": "A", "compatible": "O,A", "donor": -1}, {"id": 18, "label": "P18", "title": "<b>PAIRE #18</b><br><br><b>PATIENT:</b><br>Groupe: O<br>Cr\u00e9atinine: 0.9<br>Age: 54<br>Score Urgence: 2/100<br><br><b>DONNEUR:</b><br>Donneur: A", "val": 2, "ai_color": "#22c55e", "gt_color": "#a333ff", "cid": 3, "group": "saved", "in_any_cycle": true, "blood": "O", "compatible": "O", "donor": 0}, {"id": 19, "label": "P19", "title": "<b>PAIRE #19</b><br><br><b>PATIENT:</b><br>Groupe: A<br>Cr\u00e9atinine: 4.2<br>Age: 72<br>Score Urgence: 96/100<br><br><b>DONNEUR:</b><br>Donneur: O", "val": 96, "ai_color": "#ef4444", "gt_color": "#ff005c", "cid": 1, "group": "saved", "in_any_cycle": true, "blood": "A", "compatible": "O,A", "donor": 7}, {"id": 20, "label": "P20", "title": "<b>PAIRE #20</b><br><br><b>PATIENT:</b><br>Groupe: O<br>Cr\u00e9atinine: 1.5<br>Age: 52<br>Score Urgence: 87/100<br><br><b>DONNEUR:</b><br>Pas de donneur", "val": 87, "ai_color": "#ef4444", "gt_color": "#333", "cid": -1, "group": "lost", "in_any_cycle": false, "blood": "O", "compatible": "O", "donor": -1}, {"id": 21, "label": "P21", "title": "<b>PAIRE #21</b><br><br><b>PATIENT:</b><br>Groupe: A<br>Cr\u00e9atinine: 3.0<br>Age: 47<br>Score Urgence: 96/100<br><br><b>DONNEUR:</b><br>Pas de donneur", "val": 96, "ai_color": "#ef4444", "gt_color": "#333", "cid": -1, "group": "lost", "in_any_cycle": false, "blood": "A", "compatible": "O,A", "donor": -1}, {"id": 22, "label": "P22", "title": "<b>PAIRE #22</b><br><br><b>PATIENT:</b><br>Groupe: O<br>Cr\u00e9atinine: 1.8<br>Age: 84<br>Score Urgence: 86/100<br><br><b>DONNEUR:</b><br>Donneur: O", "val": 86, "ai_color": "#ef4444", "gt_color": "#ff005c", "cid": 1, "group": "saved", "in_any_cycle": true, "blood": "O", "compatible": "O", "donor": 19}, {"id": 23, "label": "P23", "title": "<b>PAIRE #23</b><br><br><b>PATIENT:</b><br>Groupe: A<br>Cr\u00e9atinine: 4.2<br>Age: 78<br>Score Urgence: 95/100<br><br><b>DONNEUR:</b><br>Donneur: O", "val": 95, "ai_color": "#ef4444", "gt_color": "#00d2ff", "cid": 0, "group": "saved", "in_any_cycle": true, "blood": "A", "compatible": "O,A", "donor": 16}, {"id": 24, "label": "P24", "title": "<b>PAIRE #24</b><br><br><b>PATIENT:</b><br>Groupe: A<br>Cr\u00e9atinine: 4.2<br>Age: 52<br>Score Urgence: 91/100<br><br><b>DONNEUR:</b><br>Pas de donneur", "val": 91, "ai_color": "#ef4444", "gt_color": "#333", "cid": -1, "group": "lost", "in_any_cycle": false, "blood": "A", "compatible": "O,A", "donor": -1}, {"id": 25, "label": "P25", "title": "<b>PAIRE #25</b><br><br><b>PATIENT:</b><br>Groupe: O<br>Cr\u00e9atinine: 1.5<br>Age: 37<br>Score Urgence: 2/100<br><br><b>DONNEUR:</b><br>Pas de donneur", "val": 2, "ai_color": "#22c55e", "gt_color": "#333", "cid": -1, "group": "lost", "in_any_cycle": false, "blood": "O", "compatible": "O", "donor": -1}, {"id": 26, "label": "P26", "title": "<b>PAIRE #26</b><br><br><b>PATIENT:</b><br>Groupe: A<br>Cr\u00e9atinine: 3.4<br>Age: 33<br>Score Urgence: 12/100<br><br><b>DONNEUR:</b><br>Pas de donneur", "val": 12, "ai_color": "#22c55e", "gt_color": "#333", "cid": -1, "group": "lost", "in_any_cycle": false, "blood": "A", "compatible": "O,A", "donor": -1}, {"id": 27, "label": "P27", "title": "<b>PAIRE #27</b><br><br><b>PATIENT:</b><br>Groupe: O<br>Cr\u00e9atinine: 0.9<br>Age: 75<br>Score Urgence: 0/100<br><br><b>DONNEUR:</b><br>Donneur: O", "val": 0, "ai_color": "#22c55e", "gt_color": "#333", "cid": -1, "group": "lost", "in_any_cycle": true, "blood": "O", "compatible": "O", "donor": -1}, {"id": 28, "label": "P28", "title": "<b>PAIRE #28</b><br><br><b>PATIENT:</b><br>Groupe: O<br>Cr\u00e9atinine: 2.4<br>Age: 45<br>Score Urgence: 91/100<br><br><b>DONNEUR:</b><br>Donneur: B", "val": 91, "ai_color": "#ef4444", "gt_color": "#333", "cid": -1, "group": "lost", "in_any_cycle": false, "blood": "O", "compatible": "O", "donor": -1}, {"id": 29, "label": "P29", "title": "<b>PAIRE #29</b><br><br><b>PATIENT:</b><br>Groupe: O<br>Cr\u00e9atinine: 0.9<br>Age: 30<br>Score Urgence: 93/100<br><br><b>DONNEUR:</b><br>Pas de donneur", "val": 93, "ai_color": "#ef4444", "gt_color": "#333", "cid": -1, "group": "lost", "in_any_cycle": false, "blood": "O", "compatible": "O", "donor": -1}].map(n => n.val);
    var ctx = document.getElementById('scoreChart');
    if(ctx) {
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: urgencyScores.slice(0, 20).map((_, i) => 'P' + i),
                datasets: [{
                    label: 'Score Urgence',
                    data: urgencyScores.slice(0, 20),
                    backgroundColor: urgencyScores.slice(0, 20).map(s => 
                        s > 80 ? '#ef4444' : s > 50 ? '#eab308' : '#22c55e'
                    ),
                    borderColor: '#333',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { max: 100, ticks: { color: '#888' }, grid: { color: '#222' } },
                          x: { ticks: { color: '#888' }, grid: { display: false } } },
                plugins: { legend: { display: false } }
            }
        });
    }
    
    var histCtx = document.getElementById('histChart');
    if(histCtx) {
        var bins = [0,0,0,0,0];
        urgencyScores.forEach(s => {
            if(s < 20) bins[0]++;
            else if(s < 40) bins[1]++;
            else if(s < 60) bins[2]++;
            else if(s < 80) bins[3]++;
            else bins[4]++;
        });
        new Chart(histCtx, {
            type: 'doughnut',
            data: {
                labels: ['<20 (Stable)', '20-40', '40-60', '60-80 (Grave)', '80+ (Critique)'],
                datasets: [{
                    data: bins,
                    backgroundColor: ['#22c55e', '#84cc16', '#eab308', '#f97316', '#ef4444'],
                    borderColor: '#000',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom', labels: { color: '#a1a1aa', font: { size: 10 } } } }
            }
        });
    }

    function setStep(step) {
        document.querySelectorAll('.btn').forEach((b, i) => b.classList.toggle('active', i === step-1));
        document.querySelectorAll('.story-text').forEach((d, i) => d.classList.toggle('active', i === step-1));
        
        const allNodes = nodes.get();
        const allEdges = edges.get();
        const legend = document.getElementById('legend');
        
        if(step === 1) {
            allNodes.forEach(n => { n.color = '#3f3f46'; n.size = 8; n.shadow = false; });
            allEdges.forEach(e => { e.hidden = false; e.color = {color:'#333', opacity: 0.1}; e.width=0.5; });
            legend.innerHTML = '<b>Step 1: Donn√©es</b><br><span class="dot" style="background:#3f3f46"></span>Paire (Patient + Donneur)';
        }
        
        if(step === 2) {
            allNodes.forEach(n => { n.color = n.ai_color; n.size = 5 + (n.val/8); n.shadow = true; });
            allEdges.forEach(e => { e.hidden = true; });
            legend.innerHTML = '<b>Step 2: Urgence</b><br><span class="dot" style="background:#ef4444"></span>Critique<br><span class="dot" style="background:#eab308"></span>Grave<br><span class="dot" style="background:#22c55e"></span>Stable';
        }
        
        if(step === 3) {
            // Matching view: show only cycle edges (candidates + validated)
            allNodes.forEach(n => { 
                if(n.cid > -1) {
                    n.hidden = false;
                    n.color = '#00d2ff';
                    n.size = 16;
                    // keep label for validated nodes
                } else if(n.in_any_cycle) {
                    n.hidden = false;
                    n.color = '#93c5fd';
                    n.size = 6;
                    n.label = '';
                } else {
                    // hide irrelevant nodes to reduce clutter
                    n.hidden = true;
                }
            });
            allEdges.forEach(e => {
                if(e.is_sol) { e.hidden = false; e.color = {color:'#00d2ff', opacity:0.95}; e.width=2; }
                else if(e.is_candidate) { e.hidden = false; e.color = {color:'#93c5fd', opacity:0.4}; e.width=1; }
                else { e.hidden = true; }
            });
            legend.innerHTML = '<b>Step 3: Matching</b><br><span class="dot" style="background:#00d2ff"></span>Cycle valid√© &nbsp; <span class="dot" style="background:#93c5fd"></span>Cycle candidat';
        }
        
        if(step === 4) {
            allNodes.forEach(n => { n.color = '#3b82f6'; n.size = 10; n.shadow = true; });
            allEdges.forEach(e => { e.hidden = true; });
            legend.innerHTML = '<b>Step 4: Analyse</b><br>Voir les statistiques ‚Üí';
        }
        
        nodes.update(allNodes);
        edges.update(allEdges);
    }
    
    function applyPatientCount() {
        let n = parseInt(document.getElementById('patientCountInput').value) || nodesRaw.length;
        n = Math.max(2, Math.min(nodesRaw.length, n));
        // take first n patients from the original nodesRaw order
        const filteredNodes = nodesRaw.slice(0, n).map(n => Object.assign({hidden:false}, n));
        const ids = new Set(filteredNodes.map(x => x.id));
        const filteredEdges = edgesRaw.filter(e => ids.has(e.from) && ids.has(e.to));

        // replace datasets
        nodes.clear();
        edges.clear();
        nodes.add(filteredNodes);
        edges.add(filteredEdges);

        // update small stats in sidebar if present
        const totalSpan = document.getElementById('displayTotal');
        if(totalSpan) totalSpan.innerText = String(n);

        // reapply current view styles
        setStep(currentView);
    }
    
    setStep(1);
</script>

</body>
</html>